// CampOne System DB (campone_system) - v1.4
// 인증, 사용량, 감사 로그 등 중앙 관리 데이터

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// 사용자 (중앙 관리)
// ============================================

model User {
  id            String   @id @default(uuid()) @db.Uuid
  email         String   @unique
  passwordHash  String   @map("password_hash")
  name          String
  isActive      Boolean  @default(true) @map("is_active")
  isSystemAdmin Boolean  @default(false) @map("is_system_admin")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  tenants   UserTenant[]
  auditLogs AuditLog[]

  @@map("users")
}

// ============================================
// 사용자-테넌트 매핑 (N:N)
// 한 사용자가 여러 캠프 소속 가능
// ============================================

model UserTenant {
  userId    String   @map("user_id") @db.Uuid
  tenantId  String   @map("tenant_id") @db.VarChar(50)
  role      String   @default("member") @db.VarChar(50)
  isDefault Boolean  @default(false) @map("is_default")
  joinedAt  DateTime @default(now()) @map("joined_at") @db.Timestamptz

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, tenantId])
  @@index([tenantId])
  @@map("user_tenants")
}

// ============================================
// 테넌트 메타 정보
// ============================================

model Tenant {
  tenantId   String   @id @map("tenant_id") @db.VarChar(50)
  name       String   @db.VarChar(200)
  dbName     String   @map("db_name") @db.VarChar(100)
  isActive   Boolean  @default(true) @map("is_active")
  configPath String?  @map("config_path") @db.VarChar(500)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@map("tenants")
}

// ============================================
// 감사 로그 (중앙 관리)
// ============================================

model AuditLog {
  id        Int      @id @default(autoincrement())
  actorId   String?  @map("actor_id") @db.Uuid
  tenantId  String?  @map("tenant_id") @db.VarChar(50)
  action    String   @db.VarChar(100)
  resource  String?  @db.VarChar(200)
  detail    Json?
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  actor User? @relation(fields: [actorId], references: [id])

  @@index([tenantId, createdAt(sort: Desc)])
  @@index([actorId, createdAt(sort: Desc)])
  @@map("audit_logs")
}

// ============================================
// LLM 사용량 추적 (중앙 관리)
// ============================================

model LlmUsage {
  id           Int      @id @default(autoincrement())
  tenantId     String   @map("tenant_id") @db.VarChar(50)
  service      String   @db.VarChar(50)
  provider     String   @db.VarChar(20)
  model        String   @db.VarChar(100)
  inputTokens  Int      @map("input_tokens")
  outputTokens Int      @map("output_tokens")
  latencyMs    Int?     @map("latency_ms")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@index([tenantId, createdAt(sort: Desc)])
  @@index([provider, createdAt(sort: Desc)])
  @@map("llm_usage")
}
